<!DOCTYPE html>
<html lang="en">
  <head>
    <meta content="utf-8" charset="utf-8" http-equiv="encoding">

    <script src="js/three.js"></script>
    <script src="js/MTLLoader.js"></script>
    <script src="js/OBJLoader.js"></script>

    <style>
      body,html{ background-color: black; width: 100%; height: 100%; padding: 0; margin: 0; overflow: hidden; }
      .fixed-menu {
        position: fixed;
        z-index: 1;
        display: inline-block;
        background-color: whitesmoke;
        top: 0px;
        margin: 0px;
        padding: 4px;
        width: 100%;
        border: 1px solid navy;
        -webkit-border-radius: 2px;
        border-radius: 2px;
      }
      canvas { display: block; position: absolute; margin: 0; width: 100%; height: 100%; }
    </style>

    <script>
      function initialize_event_listeners() {
        var cnvs = document.getElementById('scene');

        cnvs.addEventListener( 'wheel', (event) => {
          var pz = document.getElementById('position_z');
          var val = parseInt(pz.value) + parseInt(event.deltaY * 0.01745)
          pz.value = val;
          pz.onchange();
        }, false);

        cnvs.addEventListener( 'mousedown', (event) => {
          if (event.button == 0) {
            mouse_rotation = true;
          }
        }, false);

        cnvs.addEventListener( 'mouseup', (event) => {
          if (event.button == 0) {
            mouse_rotation = false;
          }
        }, false);

        cnvs.addEventListener( 'mousemove', (event) => {
          if (mouse_rotation) {
            event.preventDefault();
            let x = Math.abs(Obj.rotation.x);

            if (x > 2 * Math.PI ) { Obj.rotation.x = 0; }

            Obj.rotation.x += event.clientX * event.movementY * 0.000005;

            if (x > 1.57 && x < 4.71) {
              Obj.rotation.y -= event.clientY * event.movementX * 0.00001745;
            } else {
              Obj.rotation.y += event.clientY * event.movementX * 0.00001745;
            }
          }
        }, false);
      }
    </script>

    <!-- Original source code: https://codepen.io/Mamboleoo/pen/PqjGdN -->
    <!-- OBJ Examples from: https://github.com/mrdoob/three.js -->
    <!-- Also see: https://davidoreilly.itch.io/walt-disney-3d-head , http://www.davidoreilly.com/ -->
    <title>OBJ Viewer</title>
  </head>
  <body id='body' onload="initialize_event_listeners()">
    <div class="fixed-menu">
      <label for="file" style="color: navy;">MTL/OBJ: &nbsp;</label>
      <input type="file" id="file_input" name="file" onchange="init()" value="Browse" multiple />
      <label for="number">Rotate :</label>
      <label for="number" style="color: blue;">X</label>
      <input type="number" id="rotation_x" onchange="rot_x_changed()" min="-0.05" max="0.05" value="0" step="0.001" style="width: 60px;" />&nbsp;
      <label for="number" style="color: blue;">Y</label>
      <input type="number" id="rotation_y" onchange="rot_y_changed()" min="-0.05" max="0.05" value="0" step="0.001" style="width: 60px;" />&nbsp;
      <label for="number" style="color: blue;">Z</label>
      <input type="number" id="rotation_z" onchange="rot_z_changed()" min="-0.05" max="0.05" value="0" step="0.001" style="width: 60px;" />&nbsp; &nbsp; &nbsp;
      <label for="number">Position : </label>
      <label for="number" style="color: green;">X</label>
      <input type="number" id="position_x" onchange="pos_x_changed()" min="-1000" max="1000" value="0" step="1" style="width: 55px;" />&nbsp;
      <label for="number" style="color: green;">Y</label>
      <input type="number" id="position_y" onchange="pos_y_changed()" min="-1000" max="1000" value="0" step="1" style="width: 55px;" />&nbsp;
      <label for="number" style="color: green;">Z</label>
      <input type="number" id="position_z" onchange="pos_z_changed()" min="-1000" max="1000" value="0" step="1" style="width: 55px;" />&nbsp; &nbsp;
      <input type="checkbox" id="wireframe" name="wireframe" onchange="show_wireframe()" disabled />
      <label for="wireframe">Wire</label>&nbsp; &nbsp;
      <label for="back_color">Color: &nbsp;</label>
      <input type="color" id="back_color" name="back_color" onchange="set_back_color()" style="background: none; padding: 0; width: 35px;" />
      <button type="reset" id="reset" onclick="reset_all()" style="float: right; width: 55px; margin-top: 2px; margin-right: 10px;" disabled>Reset</button>
    </div><br />

    <canvas id="scene">
      Your browser does not support HTML5 canvas tag
    </canvas>

    <script>
      var renderer, scene, camera, Obj;
      var ww = window.innerWidth,	wh = window.innerHeight;
      var mouse_rotation = false, reset_rotation = false;
      var rot_x = 0, rot_y = 0, rot_z = 0, pos_x = 0, pos_y = 0, pos_z = 0;
      var selected_mtl_file = null;
      var selected_obj_file = null;

      // Manager from ThreeJs to track a loader and its status
      var manager = new THREE.LoadingManager();
      // Loader for selected file from Three.js
      const mtl_loader = new THREE.MTLLoader( manager );
      const obj_loader = new THREE.OBJLoader( manager );

      function set_back_color() { document.body.style.backgroundColor = document.getElementById('back_color').value; }

      function rot_x_changed() { rot_x = parseFloat(document.getElementById('rotation_x').value); }
      function rot_y_changed() { rot_y = parseFloat(document.getElementById('rotation_y').value); }
      function rot_z_changed() { rot_z = parseFloat(document.getElementById('rotation_z').value); }
      function pos_x_changed() { pos_x = parseInt(document.getElementById('position_x').value); }
      function pos_y_changed() { pos_y = parseInt(document.getElementById('position_y').value); }
      function pos_z_changed() { pos_z = parseInt(document.getElementById('position_z').value); }

      function init(){
        // Loaded file(s)
        var fi = document.getElementById('file_input');

        if (fi.files.length > 1) {
          if (!fi.files[0].name.endsWith('.mtl')) { return; }

          selected_mtl_file = fi.files[0];
          selected_obj_file = fi.files[1];

          mtl_loader.load( URL.createObjectURL(selected_mtl_file), (mtl) => {
            mtl.preload();
            obj_loader.setMaterials(mtl);
            selected_mtl_file = null;
          });
        } else {
          obj_loader.setMaterials(null);
          selected_obj_file = fi.files[0];
        }

        if (selected_obj_file.name.endsWith('.obj')) {
          if (scene != null) {
            scene.remove.apply(scene, scene.children);
          }

          document.getElementById('reset').disabled = false;
          document.getElementById('wireframe').disabled = false;

          renderer = new THREE.WebGLRenderer({ canvas : document.getElementById('scene'), antialias: true, alpha: true });
          renderer.setPixelRatio( window.devicePixelRatio );
          renderer.setSize(ww, wh);
          renderer.setClearColor( 0xffffff, 0); // Allow setting the background color

          // The following can be used instead of the canvas but the window mouse
          // events might be tricky to set due to the presence of the fixed menu
          //document.body.appendChild( renderer.domElement );

          scene = new THREE.Scene();

        	camera = new THREE.PerspectiveCamera( 45, ww/wh, 0.1, 2000 );
        	camera.position.set(0,0,250);
      	  scene.add(camera);

          // Add a light in the scene
        	directionalLight = new THREE.DirectionalLight( 0xffffff, 0.8 );
        	directionalLight.position.set( 0, 0, 350 );
        	directionalLight.lookAt(new THREE.Vector3(0,0,0));
      	  scene.add( directionalLight );

        	// Load the obj file
        	loadFile();
        } else {
          if (scene != null) {
            scene.remove.apply(scene, scene.children);
          }
        }
      }

      var loadFile = function(){
        // Reset all current positional and rotational values
        reset_all( true );

        // Launch loading of the selected file, addFileInScene is the callback when it's ready
        obj_loader.load( URL.createObjectURL(selected_obj_file), addFileInScene );
     };

      var addFileInScene = function(object){
        Obj = object;

        // Add the 3D object in the scene
      	scene.add( Obj );

        camera.lookAt( Obj.position );

        render();
      };

      var show_wireframe = function () {
        // Go through all children of the loaded object and search for a Mesh
        Obj.traverse( function ( child ) {
          // This allow us to check if the children is an instance of the Mesh constructor
    	    if(child instanceof THREE.Mesh){
            if (document.getElementById('wireframe').checked) {
              child.material.wireframe = true;
            } else {
              child.material.wireframe = false;
            }
    		  }
    	  });
      }

      var render = function () {
        requestAnimationFrame( render );

        // Move the Obj in the scene
        Obj.position.x = pos_x;
        Obj.position.y = pos_y;
        Obj.position.z = pos_z;

        // Reset Obj rotational values
        if (reset_rotation) {
          Obj.rotation.x = 0;
          Obj.rotation.y = 0;
          Obj.rotation.z = 0;
          reset_rotation = false;
        }

        // Rotate the Obj
        if (!mouse_rotation) {
          Obj.rotation.x += rot_x;
          Obj.rotation.y += rot_y;
          Obj.rotation.z += rot_z;
        }

      	renderer.render( scene, camera );
      };

      var reset_all = function( values_only = false ) {
        // Reset all current positional and rotational values
        rot_x = document.getElementById('rotation_x').value = 0;
        rot_y = document.getElementById('rotation_y').value = 0;
        rot_z = document.getElementById('rotation_z').value = 0;
        pos_x = document.getElementById('position_x').value = 0;
        pos_y = document.getElementById('position_y').value = 0;
        pos_z = document.getElementById('position_z').value = 0;

        // Reset the wireframe checkbox
        document.getElementById('wireframe').checked = false;

        // Reset the view
        if (!values_only) { reset_rotation = true; show_wireframe(); }
      };
    </script>
  </body>
</html>