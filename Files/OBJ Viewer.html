<!DOCTYPE html>
<html lang="en">
  <head>
    <meta content="utf-8" charset="utf-8" http-equiv="encoding">

    <script src="js/three.js"></script>
    <script src="js/OBJLoader.js"></script>

    <style>
      body,html{ width: 100%; height: 100%; background-image: url('Images/Load Image.png');  background-repeat: no-repeat; background-position: center; padding: 0; margin: 0; overflow: hidden; }
      .fixed-menu { position: fixed; z-index: 1; display: inline-block; top: 0px; margin: 0px; padding: 4px; width: 100%; border: 1px solid navy; -webkit-border-radius: 3px; border-radius: 3px; background-color: navajowhite; }
      canvas { display: block; position: absolute; top: 0; left: 0; right: 0; bottom: 0; width: 100%; height: 100%; }
    </style>

    <script>
      function initialize_event_listeners() {
        var cnvs = document.getElementById('scene');

        cnvs.addEventListener( 'wheel', (event) => {
          var pz = document.getElementById('position_z');
          var val = parseInt(pz.value) + parseInt(event.deltaY * 0.01)
          pz.value = val;
          pz.onchange();
        }, false);

        cnvs.addEventListener( 'mousedown', (event) => {
          if (event.button == 0) {
            mouse_rotation = true;
          }
        }, false);

        cnvs.addEventListener( 'mouseup', (event) => {
          if (event.button == 0) {
            mouse_rotation = false;
          }
        }, false);

        cnvs.addEventListener( 'mousemove', (event) => {
          if (mouse_rotation) {
            Obj.rotation.x += (event.clientX * event.movementY * 0.00001);
            Obj.rotation.y += (event.clientY * event.movementX * 0.00001);
          }
        }, false);
      }
    </script>

    <!-- Original source code: https://codepen.io/Mamboleoo/pen/PqjGdN -->
    <!-- OBJ Examples from: https://github.com/mrdoob/three.js -->
    <!-- Also see: https://davidoreilly.itch.io/walt-disney-3d-head , http://www.davidoreilly.com/ -->
    <title>OBJ Viewer</title>
  </head>
  <body onload="initialize_event_listeners()">
    <div class="fixed-menu">
      <label for="file" style="color: #8a480a;">Load OBJ: &nbsp;</label>
      <input type="file" id="file_input" name="file" onchange="init()">
      <label for="number">3D Rotation : </label>
      <label for="number" style="color: blue;">X</label>
      <input type="number" id="rotation_x" onchange="rot_x_changed()" min="-0.05" max="0.05" value="0" step="0.001" style="width: 60px;">&nbsp;
      <label for="number" style="color: blue;">Y</label>
      <input type="number" id="rotation_y" onchange="rot_y_changed()" min="-0.05" max="0.05" value="0" step="0.001" style="width: 60px;">&nbsp;
      <label for="number" style="color: blue;">Z</label>
      <input type="number" id="rotation_z" onchange="rot_z_changed()" min="-0.05" max="0.05" value="0" step="0.001" style="width: 60px;">&nbsp; &nbsp; &nbsp;
      <label for="number">Position : </label>
      <label for="number" style="color: green;">X</label>
      <input type="number" id="position_x" onchange="pos_x_changed()" min="-1000" max="1000" value="0" step="1" style="width: 55px;">&nbsp;
      <label for="number" style="color: green;">Y</label>
      <input type="number" id="position_y" onchange="pos_y_changed()" min="-1000" max="1000" value="0" step="1" style="width: 55px;">&nbsp;
      <label for="number" style="color: green;">Z</label>
      <input type="number" id="position_z" onchange="pos_z_changed()" min="-1000" max="1000" value="0" step="1" style="width: 55px;">
      <button id="reset" onclick="reset_all()" style="float: right; width: 55px; margin-right: 10px;" disabled>Reset</button>
    </div><br />

    <canvas id="scene">
      Your browser does not support HTML5 canvas tag
    </canvas>

    <script>
      var renderer, scene, camera, Obj;
      var ww = window.innerWidth,	wh = window.innerHeight;
      var mouse_rotation = false, reset_rotation = false;
      var rot_x = 0, rot_y = 0, rot_z = 0, pos_x = 0, pos_y = 0, pos_z = 0;
      var selected_file = null;

      //Manager from ThreeJs to track a loader and its status
      var manager = new THREE.LoadingManager();

      //Loader for selected file from Three.js
      loader = new THREE.OBJLoader( manager );

      function rot_x_changed() { rot_x = parseFloat(document.getElementById('rotation_x').value); }
      function rot_y_changed() { rot_y = parseFloat(document.getElementById('rotation_y').value); }
      function rot_z_changed() { rot_z = parseFloat(document.getElementById('rotation_z').value); }
      function pos_x_changed() { pos_x = parseInt(document.getElementById('position_x').value); }
      function pos_y_changed() { pos_y = parseInt(document.getElementById('position_y').value); }
      function pos_z_changed() { pos_z = parseInt(document.getElementById('position_z').value); }

      function init(){
        //Loaded file
        selected_file = document.getElementById('file_input').files[0];

        if (selected_file.name.endsWith('.obj')) {
          if (scene != null) {
            scene.remove.apply(scene, scene.children);
            if (scene.geometry) { scene.geometry.dispose(); scene.geometry = undefined; }
            if (scene.material) { scene.material.dispose(); scene.material = undefined; }
          }

          document.getElementById('reset').disabled = false;

          renderer = new THREE.WebGLRenderer({ canvas : document.getElementById('scene') });

          renderer.setSize(ww,wh);

          scene = new THREE.Scene();

        	camera = new THREE.PerspectiveCamera( 50, ww/wh, 1, 1000 );
        	camera.position.set(0,0,250);
      	  scene.add(camera);

          //Add a light in the scene
        	directionalLight = new THREE.DirectionalLight( 0xffffff, 0.8 );
        	directionalLight.position.set( 0, 0, 350 );
        	directionalLight.lookAt(new THREE.Vector3(0,0,0));
      	  scene.add( directionalLight );

        	//Load the obj file
        	loadFile();
        } else {
          if (scene != null) {
            scene.remove.apply(scene, scene.children);
            if (scene.geometry) { scene.geometry.dispose(); scene.geometry = undefined; }
            if (scene.material) { scene.material.dispose(); scene.material = undefined; }
          }
        }
      }

      var loadFile = function(){
        //Reset all current positional and rotational values
        reset_all( true );

        //Launch loading of the selected file, addFileInScene is the callback when it's ready
        loader.load( URL.createObjectURL(selected_file), addFileInScene );
        selected_file = null;
      };

      var addFileInScene = function(object){
        Obj = object;

        //Go through all children of the loaded object and search for a Mesh
        object.traverse( function ( child ) {
        	//This allow us to check if the children is an instance of the Mesh constructor
    	    if(child instanceof THREE.Mesh){
    		    child.material.color = new THREE.Color(0X00FF00);
    			  //Sometimes there are some vertex normals missing in the .obj files, ThreeJs will compute them
    			  child.geometry.computeVertexNormals();
    		  }
    	  });

        camera.lookAt( Obj.position );

        //Add the 3D object in the scene
      	scene.add( Obj );

        render();
      };

      var render = function () {
        requestAnimationFrame( render );

        //Move the Obj in the scene
        Obj.position.x = pos_x;
        Obj.position.y = pos_y;
        Obj.position.z = pos_z;

        //Reset rotation
        if (reset_rotation) {
          Obj.rotation.x = 0;
          Obj.rotation.y = 0;
          Obj.rotation.z = 0;
          reset_rotation = false;
          camera.lookAt( Obj.position );
        }

        //Turn the Obj
        if (!mouse_rotation) {
          Obj.rotation.x += rot_x;
          Obj.rotation.y += rot_y;
          Obj.rotation.z += rot_z;
        }

      	renderer.render( scene, camera );
      };

      var reset_all = function( values_only = false ) {
        //Reset all current positional and rotational values
        rot_x = document.getElementById('rotation_x').value = 0;
        rot_y = document.getElementById('rotation_y').value = 0;
        rot_z = document.getElementById('rotation_z').value = 0;
        pos_x = document.getElementById('position_x').value = 0;
        pos_y = document.getElementById('position_y').value = 0;
        pos_z = document.getElementById('position_z').value = 0;

        //Reset the view
        if (!values_only) { reset_rotation = true; }
      };
    </script>
  </body>
</html>